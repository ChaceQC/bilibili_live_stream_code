name: Release BiliLiveTool

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            asset_name_suffix: linux-amd64
            pyinstaller_options: ""
            icon_ext: "png"
          - os: macos-latest
            asset_name_suffix: macos-amd64
            pyinstaller_options: "--windowed"
            icon_ext: "icns"
          - os: windows-latest
            asset_name_suffix: windows-amd64
            pyinstaller_options: "--noconsole"
            icon_ext: "ico"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build
      shell: bash

    - name: Install Backend Dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller Pillow

    # --- æ ¸å¿ƒæ­¥éª¤ï¼šæ ¹æ®å¹³å°è½¬æ¢å›¾æ ‡ ---
    - name: Prepare Platform Icon
      run: |
        if [ "${{ matrix.os }}" == "macos-latest" ]; then
          echo "Converting ICO to ICNS for macOS..."
          sips -s format png bilibili.ico --out temp_icon.png
          mkdir bilibili.iconset
          sips -z 1024 1024 temp_icon.png --out bilibili.iconset/icon_512x512@2x.png
          iconutil -c icns bilibili.iconset
          rm -rf bilibili.iconset temp_icon.png
        elif [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          echo "Converting ICO to PNG for Linux..."
          python -c "from PIL import Image; Image.open('bilibili.ico').save('bilibili.png')"
        fi
      shell: bash

    - name: Package with PyInstaller
      run: |
        # ç¡®å®šå½“å‰å¹³å°åº”ä½¿ç”¨çš„å›¾æ ‡æ–‡ä»¶å
        ICON_NAME="bilibili.${{ matrix.icon_ext }}"
        
        pyinstaller main.py \
          --name BiliLiveTool \
          --onefile \
          --add-data "frontend/dist:frontend/dist" \
          --icon "$ICON_NAME" \
          ${{ matrix.pyinstaller_options }}
      shell: bash

    - name: Prepare Artifacts
      run: |
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          EXE_NAME="BiliLiveTool.exe"
          ASSET_NAME="BiliLiveTool-${{ matrix.asset_name_suffix }}.zip"
          mv dist/$EXE_NAME .
          7z a $ASSET_NAME $EXE_NAME
        elif [ "${{ matrix.os }}" == "macos-latest" ]; then
          APP_NAME="BiliLiveTool.app"
          ASSET_NAME="BiliLiveTool-${{ matrix.asset_name_suffix }}.zip"
          # macOS æ‰“åŒ…æ•´ä¸ª .app æ–‡ä»¶å¤¹
          7z a -r $ASSET_NAME dist/$APP_NAME
        else # Linux
          EXE_NAME="BiliLiveTool"
          ASSET_NAME="BiliLiveTool-${{ matrix.asset_name_suffix }}.tar.gz"
          mv dist/$EXE_NAME .
          tar -czvf $ASSET_NAME $EXE_NAME
        fi
        echo "ASSET_NAME=${ASSET_NAME}" >> $GITHUB_ENV
      shell: bash

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: BiliLiveTool-${{ matrix.asset_name_suffix }}
        path: ${{ env.ASSET_NAME }}

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*/*
        body: |
          ## ğŸš€ BiliLiveTool é¢„å‘å¸ƒç‰ˆæœ¬
          
          è¿™æ˜¯åŸºäºæ ‡ç­¾ `${{ github.ref_name }}` è‡ªåŠ¨æ„å»ºçš„ç‰ˆæœ¬ã€‚
          
          ### ğŸ“¦ å¹³å°æ”¯æŒ
          - **Windows**: åŒå‡» `.exe` è¿è¡Œ
          - **macOS**: è§£å‹åè¿è¡Œ `.app`
          - **Linux**: èµ‹äºˆæ‰§è¡Œæƒé™åè¿è¡Œ
        draft: false
        prerelease: true
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}